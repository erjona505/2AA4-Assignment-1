// --------------------------------------------------------
// Code generated by Papyrus Java
// --------------------------------------------------------
package Catan_Part1;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;
import java.util.Collections;

/**
 * Represents a player (Agent) in the Catan game.
 * Handles building roads, settlements, and cities.
 * handle the resources card that the agent has
 *
 * @author Zain Khalboos
 * Course: SFWRENG 2AA4
 * Date: 2026-02-13add
 */
public class Agent {

    private int id;
    private int edgeId;
    private int nodeId;

    private int totalPoints;
    /**
     *
     */
    private Resources resources;
    private int roadsRemaining = 15; //number of roads agent has
    private int settlementsRemaining = 5; //number of roads agent has
    private int citiesRemaining = 4;//number of roads agent has

    private final Random random = new Random();
    /**
     *Constructor for agent
     * @param id
     * @param resources
     * @param points
     */
    public Agent(int id, Resources resources, int points) {
        this.id = id;
        this.resources = resources;
        this.totalPoints = points;
    }

    /**
     * get the resources that player has
     * @return Resourses
    * */
    public Resources getResources() {
        return resources;
    }

    /**
     *get the id of the player
     * @return int
     */
    public int getId() {
        return id;
    }


    /**
     * Let the player take turn throw random building they can do with their resources
     * @param round
     * @param map
     * retun
     */
    public void takeTurn(GameMap map, int round) {

        int tries=0; //tries to make loop finite
        do { //start with one turn initially
            tries++;
            if (tries > 50) return; // safety break
            boolean built = false;

            List<Integer> options = new ArrayList<>(); //list our options
            options.add(0);
            options.add(1);
            options.add(2);
            Collections.shuffle(options, random); //shuffling the cards

            //loop through the options
            for (int choice : options) {

                if (choice == 0){
                    built = tryBuildRoad(map);

                    if (built) {
                        System.out.println(round + " / " + id + ": Built road at edge " + edgeId);
                    }
                }
                else if ( choice == 1) {
                    built = tryBuildSettlement(map);

                    if (built) {
                        System.out.println(round + " / " + id + ": Built settlement at node " + nodeId);
                    }
                }

                else {
                    built = tryBuildCity(map);

                    if (built) {
                        System.out.println(round + " / " + id + ": Upgraded to city at node " + nodeId);
                    }
                }

                if (built) {
                    break;
                }
            }


            // If nothing worked, end the turn
            if (!built) {
                return;
            }

        }while (isSevenCards());

    }

    /**
     * we try to build if we build we subtract 1 from roadsRemaining
     * @param map
     * @return boolean
     * **/
    private boolean tryBuildRoad(GameMap map) {
        if (roadsRemaining <= 0) return false;
        if(!checkRoadCost()){return false;}

        edgeId=roadLocation(map);
        if(edgeId==-1){return false;}

        if(map.placeRoad(this, edgeId)){
            buyRoad();
            roadsRemaining--;
            return true;
        }

        return false;
    }

    /**
     * we try to build if we build we subtract 1 from settlementRemaining
     * @param map
     * @return boolean
     * **/
    private boolean tryBuildSettlement(GameMap map){
        if (settlementsRemaining <= 0) return false;
        if(!checkSettlementCost()){return false;}

        nodeId=settlementLocation(map, false);
        if(nodeId==-1){return false;}

        if(map.placeSettlement(this, nodeId, false)){
            buySettlement();
            settlementsRemaining--;
            return true;
        }

        return false;
    }

    /**
     * we try to build if we build we subtract 1 from cityRemaining
     * @param map
     * @return boolean
     * **/
    private boolean tryBuildCity(GameMap map){
        if (citiesRemaining <= 0) return false;
        if(!checkCityCost()){return false;}

        nodeId=cityLocation(map);
        if (nodeId == -1) return false;

        if(map.isSettlement(this, nodeId) && checkCityCost()){
            map.upgrade(this, nodeId);
            buyCity();
            citiesRemaining--;
            settlementsRemaining++;
            return true;
        }

        return false;
    }


    /**
     *
     * get total points player has
     * @return int
     *
     * **/
    public int getTotalPoints() {
        return totalPoints;
    }

    /**
     *takes the resources from the resources list for road
     * @return boolean
     */
    public void buyRoad() {
        resources.remove(ResourceType.WOOD, 1);
        resources.remove(ResourceType.BRICK, 1);
    }


    /**
     *
     * check if we have the cost for road
     * @return boolean
    * **/
    public boolean checkRoadCost() {
        return (resources.hasResource(ResourceType.WOOD, 1) && resources.hasResource(ResourceType.BRICK, 1));
    }

    /**
     *takes the resources from the resources list for Settlement
     * @return boolean
     */
    public void buySettlement() {
        // Cost: 1 wood, 1 brick, 1 wheat, 1 sheep
        resources.remove(ResourceType.WOOD, 1);
        resources.remove(ResourceType.BRICK, 1);
        resources.remove(ResourceType.WHEAT, 1);
        resources.remove(ResourceType.SHEEP, 1);

    }


    /**
     *
     * check if we have the cost for settlement
     * @return boolean
     * **/
    public boolean checkSettlementCost() {
        return (resources.hasResource(ResourceType.WOOD, 1)
                && resources.hasResource(ResourceType.BRICK, 1)
                && resources.hasResource(ResourceType.WHEAT, 1)
                && resources.hasResource(ResourceType.SHEEP, 1));
    }

    /**
     *takes the resources from the resources list for City
     * @return boolean
     */
    public void buyCity() {
        // Cost: 2 wheat, 3 ore
        resources.remove(ResourceType.WHEAT, 2);
        resources.remove(ResourceType.ORE, 3);
    }

    /**
     *
     * check if we have the cost for city
     * @return boolean
     * **/
    public boolean checkCityCost() {
        return resources.hasResource(ResourceType.WHEAT, 2) && resources.hasResource(ResourceType.ORE, 3);
    }

    /**
     *check if we have more than 7 cards
     * @return boolean
     */
    public boolean isSevenCards() {
        return resources.totalCards()>7;
    }

    /**
     *add points to player
     * @param points
     */
    public void addPoints(int points) {
        this.totalPoints += points;
    }

    /**
     * checks valid position for placement for settlement
     * @param isInitialPlacement
     * @param map
     * @return int
     * **/
    public int settlementLocation(GameMap map, boolean isInitialPlacement) {
        List<Integer> validNodes = new ArrayList<>();

        //loop through nodes
        for (int i = 0; i < 54; i++) {
            Node node = map.getNode(i);
            if (node == null || node.isOccupied()) continue;
            if(!map.isValidSettlementPosition(i)) {
                continue;
            }
            if(!isInitialPlacement && !map.hasAdjacentRoad(this,i)){
                continue;
            }
            validNodes.add(i);
        }

        if(validNodes.isEmpty()) {
            return -1;
        }

        return validNodes.get(random.nextInt(validNodes.size()));
    }

    /**
     * checks valid position for placement for road
     * @param map
     * @return int
     * **/
    public int roadLocation(GameMap map){
        ArrayList<Integer> validEdges = new ArrayList<>();

        //loop through edges
        for (int i = 0; i < 72; i++) {
            Edge edge = map.getEdge(i);
            if(edge == null || edge.isOccupied()) { continue;}
            if(!map.isConnectedToAgent(this, i)){continue;}
            validEdges.add(i);
        }

        if(validEdges.isEmpty()) {
            return -1;
        }

        return validEdges.get(random.nextInt(validEdges.size()));
    }

    /**
     * checks valid position for placement for city
     * @param map
     * @return int
     * **/
    private int cityLocation(GameMap map) {
        List<Integer> valid = new ArrayList<>();

        //loop through nodes
        for (int i = 0; i < 54; i++) {
            if (map.isSettlement(this, i)) {
                valid.add(i);
            }
        }

        if (valid.isEmpty()) return -1;

        return valid.get(random.nextInt(valid.size()));
    }

}
